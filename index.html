<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Multi-Stream Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0e0e10;
            color: white;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #9146ff, #772ce8);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 700;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .btn.active {
            background: #00ff88;
            color: #0e0e10;
            font-weight: bold;
        }

        .main-container {
            margin-top: 60px;
            height: calc(100vh - 60px);
            position: relative;
            display: flex;
        }

        .content-area {
            flex: 1;
            position: relative;
            transition: all 0.3s ease;
        }

        .content-area.with-chat {
            margin-right: 350px;
        }

        /* Chat Panel Styles */
        .chat-panel {
            position: fixed;
            top: 60px;
            right: -350px;
            width: 350px;
            height: calc(100vh - 60px);
            background: #18181b;
            border-left: 2px solid #333;
            transition: right 0.3s ease;
            z-index: 500;
            display: flex;
            flex-direction: column;
        }

        .chat-panel.open {
            right: 0;
        }

        .chat-header {
            padding: 15px;
            background: #1f1f23;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            color: #9146ff;
            font-size: 16px;
        }

        .chat-close {
            background: none;
            border: none;
            color: #999;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }

        .chat-close:hover {
            background: #333;
            color: white;
        }

        .chat-selector {
            padding: 10px 15px;
            background: #1a1a1d;
            border-bottom: 1px solid #333;
        }

        .chat-selector select {
            width: 100%;
            padding: 8px;
            background: #0e0e10;
            color: white;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 14px;
        }

        .chat-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .chat-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #0e0e10;
        }

        .chat-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            text-align: center;
            padding: 20px;
        }

        /* Layout Container */
        .layout-container {
            position: relative;
            width: 100%;
            height: 100%;
            padding: 2px;
            transition: all 0.3s ease;
        }

        /* Grid View Styles */
        .layout-container.grid-view {
            display: grid;
            gap: 2px;
        }

        .layout-container.grid-1 { grid-template-columns: 1fr; }
        .layout-container.grid-2 { grid-template-columns: 1fr 1fr; }
        .layout-container.grid-3 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .layout-container.grid-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .layout-container.grid-5, .layout-container.grid-6 { grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr; }

        /* Theater View Styles */
        .layout-container.theater-view {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .main-stream-area {
            flex: 1;
            position: relative;
            background: #1a1a1d;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .sub-streams-area {
            height: 120px;
            display: flex;
            gap: 2px;
            overflow-x: auto;
            padding: 2px 0;
            transition: all 0.3s ease;
        }

        /* Stream Container Styles */
        .stream-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #1a1a1d;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stream-container:hover {
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(145, 70, 255, 0.2);
        }

        .stream-container.active {
            box-shadow: 0 0 0 3px #00ff88;
        }

        .stream-container.muted {
            opacity: 0.7;
        }

        .stream-container.locked .stream-iframe {
            pointer-events: none;
        }

        .stream-container.theater-main {
            width: 100%;
            height: 100%;
        }

        .stream-container.theater-sub {
            min-width: 200px;
            height: 100%;
            border-radius: 6px;
        }

        .stream-container.theater-sub:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(145, 70, 255, 0.3);
        }

        .stream-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
            pointer-events: auto;
        }

        .stream-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.7) 100%);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 10;
        }

        .stream-container:hover .stream-overlay,
        .stream-container.locked .stream-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        .stream-info {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .stream-name {
            background: rgba(0,0,0,0.8);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .stream-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .stream-btn {
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            min-width: 24px;
            text-align: center;
        }

        .stream-btn:hover {
            background: #9146ff;
        }

        .stream-btn.audio-active {
            background: #00ff88;
            color: #0e0e10;
        }

        .stream-btn.lock-active {
            background: #ff6b6b;
            color: white;
        }

        .stream-btn.chat-active {
            background: #9146ff;
            color: white;
        }

        .add-stream {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #9146ff, #772ce8);
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 200px;
        }

        .add-stream:hover {
            border-color: #00ff88;
            transform: scale(1.02);
        }

        .add-stream-content {
            text-align: center;
            padding: 20px;
        }

        .add-stream-icon {
            font-size: 3em;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .add-stream.theater-sub {
            min-width: 200px;
            height: 100%;
            min-height: auto;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: #18181b;
            padding: 30px;
            border-radius: 12px;
            min-width: 400px;
            max-width: 500px;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #9146ff;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #333;
            border-radius: 6px;
            background: #0e0e10;
            color: white;
            font-size: 16px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #9146ff;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .modal-btn.primary {
            background: #9146ff;
            color: white;
        }

        .modal-btn.secondary {
            background: #333;
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 10px;
            }
            
            .controls {
                gap: 5px;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .sub-streams-area {
                height: 80px;
            }
            
            .stream-container.theater-sub {
                min-width: 140px;
            }

            .chat-panel {
                width: 300px;
                right: -300px;
            }

            .content-area.with-chat {
                margin-right: 300px;
            }
        }

        /* Loading animation */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #1a1a1d;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 5;
        }

        .loading::after {
            content: '';
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top: 4px solid #9146ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animation classes for smooth transitions */
        .stream-container.moving {
            z-index: 100;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stream-container.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎮 Twitch Multi-Viewer</h1>
        <div class="controls">
            <button class="btn" id="gridViewBtn" onclick="switchToGrid()">Grid View</button>
            <button class="btn active" id="theaterViewBtn" onclick="switchToTheater()">Theater View</button>
            <button class="btn" onclick="addStream()">+ Add Stream</button>
            <button class="btn" onclick="toggleChat()">💬 Chat</button>
            <button class="btn" onclick="muteAll()">🔇 Mute All</button>
            <button class="btn" onclick="resetLayout()">🔄 Reset</button>
        </div>
    </div>

    <div class="main-container" id="mainContainer">
        <div class="content-area" id="contentArea">
            <div class="layout-container theater-view" id="layoutContainer">
                <!-- Streams will be dynamically positioned here -->
            </div>
        </div>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <h3>💬 Chat</h3>
            <button class="chat-close" onclick="toggleChat()">×</button>
        </div>
        <div class="chat-selector">
            <select id="chatSelector" onchange="changeChatStream()">
                <option value="">Select a stream for chat...</option>
            </select>
        </div>
        <div class="chat-container">
            <div class="chat-placeholder" id="chatPlaceholder">
                Select a stream above to view its chat
            </div>
            <iframe class="chat-iframe" id="chatIframe" style="display: none;"></iframe>
        </div>
    </div>

    <!-- Add/Edit Stream Modal -->
    <div class="modal" id="streamModal">
        <div class="modal-content">
            <h3 id="modalTitle">Add New Stream</h3>
            <div class="input-group">
                <label for="streamerName">Streamer Username:</label>
                <input type="text" id="streamerName" placeholder="Enter Twitch username..." />
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveStream()">Save</button>
            </div>
        </div>
    </div>

    <script>
        class TwitchMultiViewer {
            constructor() {
                this.streams = [
                    { id: 1, username: 'grits', active: false, locked: true },
                    { id: 2, username: 'opmarked', active: false, locked: true },
                    { id: 3, username: 'bobbypoffgaming', active: false, locked: true },
                    { id: 4, username: 'slater', active: false, locked: true }
                ];
                this.currentView = 'theater';
                this.activeAudioStream = 1;
                this.mainStream = 1;
                this.editingStreamId = null;
                this.maxStreams = 12;
                this.chatOpen = false;
                this.currentChatStream = null;
                this.streamElements = new Map();
                this.isTransitioning = false;
                
                // Fixed parent domains for GitHub Pages
                this.parentDomains = this.getParentDomains();
                
                this.init();
            }

            getParentDomains() {
                const hostname = window.location.hostname;
                
                // Handle GitHub Pages domains
                if (hostname.includes('github.io')) {
                    return [hostname, 'localhost', '127.0.0.1'];
                }
                
                // Handle custom domains or local development
                if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '') {
                    return ['localhost', '127.0.0.1', 'tbenitz.github.io'];
                }
                
                // Default case
                return [hostname, 'localhost'];
            }

            getEmbedUrl(username, type = 'player') {
                const parentParam = this.parentDomains.join('&parent=');
                
                if (type === 'chat') {
                    return `https://www.twitch.tv/embed/${username}/chat?parent=${parentParam}&darkpopout`;
                }
                
                // Use the most stable player URL format for authentication persistence
                return `https://player.twitch.tv/?channel=${username}&parent=${parentParam}&muted=false&autoplay=false&controls=true&time=0`;
            }

            init() {
                this.loadFromStorage();
                this.createInitialStreams();
                this.updateLayout();
                this.setupEventListeners();
                this.updateChatSelector();
            }

            loadFromStorage() {
                const saved = localStorage.getItem('twitchMultiViewer');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.streams = data.streams || this.streams;
                        this.currentView = data.currentView || this.currentView;
                        this.activeAudioStream = data.activeAudioStream || this.activeAudioStream;
                        this.mainStream = data.mainStream || this.mainStream;
                        this.chatOpen = data.chatOpen || this.chatOpen;
                        this.currentChatStream = data.currentChatStream || this.currentChatStream;
                        
                        // Ensure all streams have locked property
                        this.streams.forEach(stream => {
                            if (stream.locked === undefined) {
                                stream.locked = true;
                            }
                        });
                    } catch (e) {
                        console.warn('Failed to load saved data:', e);
                    }
                }
            }

            saveToStorage() {
                const data = {
                    streams: this.streams,
                    currentView: this.currentView,
                    activeAudioStream: this.activeAudioStream,
                    mainStream: this.mainStream,
                    chatOpen: this.chatOpen,
                    currentChatStream: this.currentChatStream
                };
                localStorage.setItem('twitchMultiViewer', JSON.stringify(data));
            }

            createInitialStreams() {
                const container = document.getElementById('layoutContainer');
                
                // Create stream elements for each stream
                this.streams.forEach(stream => {
                    if (!this.streamElements.has(stream.id)) {
                        const elementData = this.createStreamElement(stream);
                        this.streamElements.set(stream.id, elementData);
                        container.appendChild(elementData.container);
                        this.loadStream(stream.id);
                    }
                });

                // Create add stream button
                if (this.streams.length < this.maxStreams) {
                    this.createAddStreamButton();
                }
            }

            createStreamElement(stream) {
                const isActive = this.activeAudioStream === stream.id;
                const isLocked = stream.locked;
                const isChatActive = this.currentChatStream === stream.id;
                
                // Use the fixed embed URL
                const embedUrl = this.getEmbedUrl(stream.username, 'player');
                
                // Create container
                const container = document.createElement('div');
                container.className = `stream-container ${isActive ? 'active' : ''} ${!isActive ? 'muted' : ''} ${isLocked ? 'locked' : ''}`;
                container.setAttribute('data-stream-id', stream.id);
                
                // Create loading element
                const loading = document.createElement('div');
                loading.className = 'loading';
                loading.id = `loading-${stream.id}`;
                
                // Create iframe with proper attributes for authentication persistence
                const iframe = document.createElement('iframe');
                iframe.className = 'stream-iframe';
                iframe.id = `iframe-${stream.id}`;
                iframe.src = embedUrl;
                iframe.allowFullscreen = true;
                iframe.allow = 'autoplay; fullscreen; microphone; camera';
                iframe.referrerPolicy = 'origin';
                iframe.sandbox = 'allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-forms';
                iframe.style.display = 'none';
                
                // Create overlay
                const overlay = document.createElement('div');
                overlay.className = 'stream-overlay';
                
                // Create stream info
                const streamInfo = document.createElement('div');
                streamInfo.className = 'stream-info';
                
                // Create stream name
                const streamName = document.createElement('div');
                streamName.className = 'stream-name';
                streamName.textContent = stream.username;
                
                // Create controls container
                const controls = document.createElement('div');
                controls.className = 'stream-controls';
                
                // Create individual control buttons
                const mainBtn = document.createElement('button');
                mainBtn.className = 'stream-btn';
                mainBtn.textContent = '📺';
                mainBtn.title = 'Set as main stream';
                mainBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.setMainStream(stream.id);
                });
                
                const audioBtn = document.createElement('button');
                audioBtn.className = `stream-btn ${isActive ? 'audio-active' : ''}`;
                audioBtn.textContent = isActive ? '🔊' : '🔇';
                audioBtn.title = 'Toggle audio';
                audioBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleStreamAudio(stream.id);
                });
                
                const chatBtn = document.createElement('button');
                chatBtn.className = `stream-btn ${isChatActive ? 'chat-active' : ''}`;
                chatBtn.textContent = '💬';
                chatBtn.title = 'Show chat';
                chatBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.setChatStream(stream.id);
                });
                
                const lockBtn = document.createElement('button');
                lockBtn.className = `stream-btn ${isLocked ? 'lock-active' : ''}`;
                lockBtn.textContent = isLocked ? '🔒' : '🔓';
                lockBtn.title = 'Lock/unlock stream controls';
                lockBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleStreamLock(stream.id);
                });
                
                const editBtn = document.createElement('button');
                editBtn.className = 'stream-btn';
                editBtn.textContent = '✏️';
                editBtn.title = 'Edit stream';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.editStream(stream.id);
                });
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'stream-btn';
                removeBtn.textContent = '❌';
                removeBtn.title = 'Remove stream';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.removeStream(stream.id);
                });
                
                // Assemble controls
                controls.appendChild(mainBtn);
                controls.appendChild(audioBtn);
                controls.appendChild(chatBtn);
                controls.appendChild(lockBtn);
                controls.appendChild(editBtn);
                controls.appendChild(removeBtn);
                
                // Assemble stream info
                streamInfo.appendChild(streamName);
                
                // Assemble overlay
                overlay.appendChild(streamInfo);
                overlay.appendChild(controls);
                
                // Assemble container
                container.appendChild(loading);
                container.appendChild(iframe);
                container.appendChild(overlay);
                
                // Add click handler for stream interaction
                container.addEventListener('click', (e) => {
                    this.handleStreamClick(stream.id, e);
                });

                // Return object with all references for easy access
                return {
                    container,
                    iframe,
                    loading,
                    overlay,
                    streamName,
                    controls,
                    buttons: {
                        main: mainBtn,
                        audio: audioBtn,
                        chat: chatBtn,
                        lock: lockBtn,
                        edit: editBtn,
                        remove: removeBtn
                    }
                };
            }

            createAddStreamButton() {
                const container = document.getElementById('layoutContainer');
                
                if (!this.addStreamElement) {
                    this.addStreamElement = document.createElement('div');
                    this.addStreamElement.className = 'add-stream';
                    this.addStreamElement.innerHTML = `
                        <div class="add-stream-content">
                            <div class="add-stream-icon">+</div>
                            <div>Add Stream</div>
                        </div>
                    `;
                    this.addStreamElement.addEventListener('click', () => this.addStream());
                }
                
                container.appendChild(this.addStreamElement);
            }

            loadStream(streamId) {
                const elementData = this.streamElements.get(streamId);
                if (!elementData) return;
                
                const { iframe, loading } = elementData;
                
                // Add load event listener to hide loading when iframe loads
                iframe.addEventListener('load', () => {
                    if (loading.parentElement) {
                        loading.style.display = 'none';
                        iframe.style.display = 'block';
                    }
                });
                
                // Fallback timeout in case load event doesn't fire
                setTimeout(() => {
                    if (loading.parentElement) {
                        loading.style.display = 'none';
                        iframe.style.display = 'block';
                    }
                }, 3000);
            }

            updateLayout() {
                if (this.isTransitioning) return;
                
                this.isTransitioning = true;
                const container = document.getElementById('layoutContainer');
                
                // Remove existing layout classes
                container.className = 'layout-container';
                
                if (this.currentView === 'grid') {
                    this.arrangeGridLayout(container);
                } else {
                    this.arrangeTheaterLayout(container);
                }
                
                this.updateViewButtons();
                this.updateChatPanel();
                this.updateAllStreamStates();
                this.saveToStorage();
                
                // Reset transition flag after animation
                setTimeout(() => {
                    this.isTransitioning = false;
                }, 300);
            }

            arrangeGridLayout(container) {
                const streamCount = this.streams.length;
                const gridClass = `grid-${Math.min(streamCount, 6)}`;
                container.classList.add('grid-view', gridClass);
                
                // Position existing stream elements
                this.streams.forEach((stream, index) => {
                    const elementData = this.streamElements.get(stream.id);
                    if (elementData) {
                        elementData.container.className = `stream-container ${this.getStreamClasses(stream)}`;
                        elementData.container.style.order = index;
                        this.updateButtonVisibility(elementData, false);
                    }
                });

                // Position add button
                if (this.addStreamElement && this.streams.length < this.maxStreams) {
                    this.addStreamElement.className = 'add-stream';
                    this.addStreamElement.style.order = this.streams.length;
                }
            }

            arrangeTheaterLayout(container) {
                container.classList.add('theater-view');
                
                // Create main and sub areas if they don't exist
                let mainArea = container.querySelector('.main-stream-area');
                let subArea = container.querySelector('.sub-streams-area');
                
                if (!mainArea) {
                    mainArea = document.createElement('div');
                    mainArea.className = 'main-stream-area';
                    container.appendChild(mainArea);
                }
                
                if (!subArea) {
                    subArea = document.createElement('div');
                    subArea.className = 'sub-streams-area';
                    container.appendChild(subArea);
                }

                // Move main stream to main area
                const mainStreamData = this.streams.find(s => s.id === this.mainStream) || this.streams[0];
                if (mainStreamData) {
                    const elementData = this.streamElements.get(mainStreamData.id);
                    if (elementData) {
                        elementData.container.className = `stream-container theater-main ${this.getStreamClasses(mainStreamData)}`;
                        this.updateButtonVisibility(elementData, true);
                        mainArea.appendChild(elementData.container);
                    }
                }

                // Move sub streams to sub area
                this.streams.filter(s => s.id !== this.mainStream).forEach(stream => {
                    const elementData = this.streamElements.get(stream.id);
                    if (elementData) {
                        elementData.container.className = `stream-container theater-sub ${this.getStreamClasses(stream)}`;
                        this.updateButtonVisibility(elementData, false);
                        subArea.appendChild(elementData.container);
                    }
                });

                // Move add button to sub area
                if (this.addStreamElement && this.streams.length < this.maxStreams) {
                    this.addStreamElement.className = 'add-stream theater-sub';
                    subArea.appendChild(this.addStreamElement);
                }
            }

            updateButtonVisibility(elementData, isMain) {
                // Only hide/show the main button, never recreate
                elementData.buttons.main.style.display = isMain ? 'none' : 'inline-block';
            }

            getStreamClasses(stream) {
                const isActive = this.activeAudioStream === stream.id;
                const isLocked = stream.locked;
                
                let classes = '';
                if (isActive) classes += 'active ';
                if (!isActive) classes += 'muted ';
                if (isLocked) classes += 'locked ';
                
                return classes.trim();
            }

            updateAllStreamStates() {
                this.streams.forEach(stream => {
                    this.updateSingleStreamState(stream.id);
                });
            }

            updateSingleStreamState(streamId) {
                const stream = this.streams.find(s => s.id === streamId);
                const elementData = this.streamElements.get(streamId);
                
                if (!stream || !elementData) return;
                
                const isActive = this.activeAudioStream === streamId;
                const isLocked = stream.locked;
                const isChatActive = this.currentChatStream === streamId;
                
                // Update container classes
                elementData.container.className = elementData.container.className.replace(/\b(active|muted|locked)\b/g, '');
                if (isActive) elementData.container.classList.add('active');
                if (!isActive) elementData.container.classList.add('muted');
                if (isLocked) elementData.container.classList.add('locked');
                
                // Update stream name
                elementData.streamName.textContent = stream.username;
                
                // Update button states
                elementData.buttons.audio.className = `stream-btn ${isActive ? 'audio-active' : ''}`;
                elementData.buttons.audio.textContent = isActive ? '🔊' : '🔇';
                
                elementData.buttons.chat.className = `stream-btn ${isChatActive ? 'chat-active' : ''}`;
                
                elementData.buttons.lock.className = `stream-btn ${isLocked ? 'lock-active' : ''}`;
                elementData.buttons.lock.textContent = isLocked ? '🔒' : '🔓';
            }

            setupEventListeners() {
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) return;
                    
                    // Number keys 1-9 to switch main stream in theater mode
                    if (e.key >= '1' && e.key <= '9') {
                        const streamIndex = parseInt(e.key) - 1;
                        if (this.currentView === 'theater' && this.streams[streamIndex]) {
                            this.setMainStream(this.streams[streamIndex].id);
                        }
                    }
                    
                    // Space to toggle audio
                    if (e.key === ' ') {
                        e.preventDefault();
                        this.toggleAudio();
                    }
                    
                    // Tab to switch views
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        this.currentView === 'grid' ? this.switchToTheater() : this.switchToGrid();
                    }

                    // C to toggle chat
                    if (e.key === 'c' || e.key === 'C') {
                        this.toggleChat();
                    }
                });
            }

            switchToGrid() {
                this.currentView = 'grid';
                this.updateLayout();
            }

            switchToTheater() {
                this.currentView = 'theater';
                this.updateLayout();
            }

            updateViewButtons() {
                const gridBtn = document.getElementById('gridViewBtn');
                const theaterBtn = document.getElementById('theaterViewBtn');
                
                gridBtn.classList.toggle('active', this.currentView === 'grid');
                theaterBtn.classList.toggle('active', this.currentView === 'theater');
            }

            setMainStream(streamId) {
                if (this.currentView === 'theater' && this.mainStream !== streamId) {
                    this.mainStream = streamId;
                    this.updateLayout();
                }
            }

            toggleStreamLock(streamId) {
                const stream = this.streams.find(s => s.id === streamId);
                if (stream) {
                    stream.locked = !stream.locked;
                    this.updateSingleStreamState(streamId);
                    this.saveToStorage();
                }
            }

            handleStreamClick(streamId, event) {
                const stream = this.streams.find(s => s.id === streamId);
                if (!stream) return;
                
                // If in theater view and clicking a sub stream, make it main
                if (this.currentView === 'theater' && this.mainStream !== streamId) {
                    this.setMainStream(streamId);
                    return;
                }
                
                // If stream is unlocked, allow iframe interaction
                if (!stream.locked) {
                    return;
                }
            }

            toggleStreamAudio(streamId) {
                const wasActive = this.activeAudioStream === streamId;
                
                // Update active audio stream
                this.activeAudioStream = wasActive ? null : streamId;
                
                // Update all stream states
                this.updateAllStreamStates();
                this.saveToStorage();
            }

            toggleAudio() {
                if (this.activeAudioStream) {
                    this.muteAll();
                } else if (this.streams.length > 0) {
                    const targetStream = this.mainStream || this.streams[0].id;
                    this.toggleStreamAudio(targetStream);
                }
            }

            muteAll() {
                this.activeAudioStream = null;
                this.updateAllStreamStates();
                this.saveToStorage();
            }

            toggleChat() {
                this.chatOpen = !this.chatOpen;
                this.updateChatPanel();
                this.saveToStorage();
            }

            updateChatPanel() {
                const chatPanel = document.getElementById('chatPanel');
                const contentArea = document.getElementById('contentArea');
                
                chatPanel.classList.toggle('open', this.chatOpen);
                contentArea.classList.toggle('with-chat', this.chatOpen);
            }

            updateChatSelector() {
                const selector = document.getElementById('chatSelector');
                if (!selector) return;
                
                selector.innerHTML = '<option value="">Select a stream for chat...</option>';
                
                this.streams.forEach(stream => {
                    const option = document.createElement('option');
                    option.value = stream.id;
                    option.textContent = stream.username;
                    if (stream.id === this.currentChatStream) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
            }

            setChatStream(streamId) {
                this.currentChatStream = streamId;
                this.chatOpen = true;
                this.updateChatPanel();
                this.changeChatStream();
                this.updateAllStreamStates();
                this.saveToStorage();
            }

            changeChatStream() {
                const selector = document.getElementById('chatSelector');
                const chatIframe = document.getElementById('chatIframe');
                const chatPlaceholder = document.getElementById('chatPlaceholder');
                
                const streamId = selector.value || this.currentChatStream;
                
                if (streamId) {
                    const stream = this.streams.find(s => s.id == streamId);
                    if (stream) {
                        // Use the fixed chat URL
                        const newChatUrl = this.getEmbedUrl(stream.username, 'chat');
                        
                        if (chatIframe.src !== newChatUrl) {
                            chatIframe.src = newChatUrl;
                            // Set proper attributes for chat iframe
                            chatIframe.referrerPolicy = 'origin';
                            chatIframe.sandbox = 'allow-scripts allow-same-origin allow-popups allow-forms';
                        }
                        
                        chatIframe.style.display = 'block';
                        chatPlaceholder.style.display = 'none';
                        
                        this.currentChatStream = parseInt(streamId);
                    }
                } else {
                    chatIframe.style.display = 'none';
                    chatPlaceholder.style.display = 'flex';
                    this.currentChatStream = null;
                }
                
                this.saveToStorage();
            }

            addStream() {
                this.editingStreamId = null;
                document.getElementById('modalTitle').textContent = 'Add New Stream';
                document.getElementById('streamerName').value = '';
                document.getElementById('streamModal').style.display = 'flex';
                document.getElementById('streamerName').focus();
            }

            editStream(streamId) {
                const stream = this.streams.find(s => s.id === streamId);
                if (!stream) return;
                
                this.editingStreamId = streamId;
                document.getElementById('modalTitle').textContent = 'Edit Stream';
                document.getElementById('streamerName').value = stream.username;
                document.getElementById('streamModal').style.display = 'flex';
                document.getElementById('streamerName').focus();
            }

            saveStream() {
                const username = document.getElementById('streamerName').value.trim().toLowerCase();
                
                if (!username) {
                    alert('Please enter a streamer username');
                    return;
                }
                
                if (this.editingStreamId) {
                    // Edit existing stream
                    const stream = this.streams.find(s => s.id === this.editingStreamId);
                    if (stream && stream.username !== username) {
                        stream.username = username;
                        
                        // Update iframe with new URL
                        const elementData = this.streamElements.get(this.editingStreamId);
                        if (elementData) {
                            const newSrc = this.getEmbedUrl(username, 'player');
                            
                            // Show loading and update iframe
                            elementData.loading.style.display = 'flex';
                            elementData.iframe.style.display = 'none';
                            elementData.iframe.src = newSrc;
                            
                            // Load the updated stream
                            this.loadStream(this.editingStreamId);
                            this.updateSingleStreamState(this.editingStreamId);
                        }
                        
                        this.updateChatSelector();
                    }
                } else {
                    // Add new stream
                    if (this.streams.length >= this.maxStreams) {
                        alert(`Maximum ${this.maxStreams} streams allowed`);
                        return;
                    }
                    
                    const newId = Math.max(...this.streams.map(s => s.id), 0) + 1;
                    const newStream = {
                        id: newId,
                        username: username,
                        active: false,
                        locked: true
                    };
                    
                    this.streams.push(newStream);
                    
                    // Create new stream element
                    const elementData = this.createStreamElement(newStream);
                    this.streamElements.set(newId, elementData);
                    
                    // Add to container
                    const container = document.getElementById('layoutContainer');
                    if (this.addStreamElement && this.addStreamElement.parentElement) {
                        container.insertBefore(elementData.container, this.addStreamElement);
                    } else {
                        container.appendChild(elementData.container);
                    }
                    
                    // Update layout and start loading
                    this.updateLayout();
                    this.loadStream(newId);
                    this.updateChatSelector();
                    
                    // Remove add button if at max
                    if (this.streams.length >= this.maxStreams && this.addStreamElement) {
                        this.addStreamElement.remove();
                        this.addStreamElement = null;
                    }
                }
                
                this.closeModal();
                this.saveToStorage();
            }

            removeStream(streamId) {
                if (this.streams.length <= 1) {
                    alert('At least one stream is required');
                    return;
                }
                
                // Remove from streams array
                this.streams = this.streams.filter(s => s.id !== streamId);
                
                // Remove DOM element
                const elementData = this.streamElements.get(streamId);
                if (elementData && elementData.container.parentElement) {
                    elementData.container.remove();
                }
                this.streamElements.delete(streamId);
                
                // Update references if needed
                if (this.activeAudioStream === streamId) {
                    this.activeAudioStream = this.streams[0]?.id || null;
                }
                if (this.mainStream === streamId) {
                    this.mainStream = this.streams[0]?.id || 1;
                }
                if (this.currentChatStream === streamId) {
                    this.currentChatStream = null;
                    this.changeChatStream();
                }
                
                // Add back add button if needed
                if (this.streams.length < this.maxStreams && !this.addStreamElement) {
                    this.createAddStreamButton();
                }
                
                this.updateLayout();
                this.updateChatSelector();
            }

            resetLayout() {
                // Remove all existing elements
                this.streamElements.forEach(elementData => {
                    if (elementData.container.parentElement) {
                        elementData.container.remove();
                    }
                });
                this.streamElements.clear();
                
                if (this.addStreamElement && this.addStreamElement.parentElement) {
                    this.addStreamElement.remove();
                }
                this.addStreamElement = null;
                
                // Reset to default
                this.streams = [
                    { id: 1, username: 'grits', active: false, locked: true },
                    { id: 2, username: 'opmarked', active: false, locked: true },
                    { id: 3, username: 'bobbypoffgaming', active: false, locked: true },
                    { id: 4, username: 'slater', active: false, locked: true }
                ];
                this.activeAudioStream = 1;
                this.mainStream = 1;
                this.currentChatStream = null;
                this.chatOpen = false;
                
                // Recreate everything
                this.createInitialStreams();
                this.updateLayout();
                this.updateChatSelector();
            }

            closeModal() {
                document.getElementById('streamModal').style.display = 'none';
            }
        }

        // Global app instance
        const app = new TwitchMultiViewer();

        // Global functions for inline event handlers
        function switchToGrid() {
            app.switchToGrid();
        }

        function switchToTheater() {
            app.switchToTheater();
        }

        function addStream() {
            app.addStream();
        }

        function toggleChat() {
            app.toggleChat();
        }

        function muteAll() {
            app.muteAll();
        }

        function resetLayout() {
            app.resetLayout();
        }

        function closeModal() {
            app.closeModal();
        }

        function saveStream() {
            app.saveStream();
        }

        function changeChatStream() {
            app.changeChatStream();
        }

        // Modal keyboard handling
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('streamModal');
            if (modal.style.display === 'flex') {
                if (e.key === 'Escape') {
                    app.closeModal();
                } else if (e.key === 'Enter') {
                    app.saveStream();
                }
            }
        });

        // Click outside modal to close
        document.getElementById('streamModal').addEventListener('click', (e) => {
            if (e.target.id === 'streamModal') {
                app.closeModal();
            }
        });

        // Click outside chat panel to close on mobile
        document.addEventListener('click', (e) => {
            const chatPanel = document.getElementById('chatPanel');
            const chatBtn = e.target.closest('.btn');
            
            if (window.innerWidth <= 768 &&
                app.chatOpen &&
                !chatPanel.contains(e.target) &&
                (!chatBtn || !chatBtn.textContent.includes('Chat'))) {
                app.toggleChat();
            }
        });
    </script>
</body>
</html>
